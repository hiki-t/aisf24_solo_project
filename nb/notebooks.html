
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>My Solo project #1 &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'nb/notebooks';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Markdown Files" href="markdown.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <img src="../_static/logo.png" class="logo__image only-dark pst-js-only" alt="My sample book - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to my AISF work
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Learning materials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="markdown.html">Learning materials</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">My work</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">My Solo project #1</a></li>


</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fnb/notebooks.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/nb/notebooks.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>My Solo project #1</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">My Solo project #1</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exp1">Exp1</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-packages">0-1. prepare packages</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#run-exp">1-1. run exp</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#result1">Result1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exp2">Exp2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#result2">Result2</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <br>
<section class="tex2jax_ignore mathjax_ignore" id="my-solo-project-1">
<h1>My Solo project #1<a class="headerlink" href="#my-solo-project-1" title="Link to this heading">#</a></h1>
<br><br>
<section id="exp1">
<h2>Exp1<a class="headerlink" href="#exp1" title="Link to this heading">#</a></h2>
<p>The first exp will test to replicate one of the <a class="reference external" href="https://transformer-circuits.pub/2022/toy_model/index.html">Anthropic research outcome (Elhage et al., 2022)</a> (see the left square box in the diagram below), compressing feature representations of a toy model from a larger dim into a smaller dim (2 dim) will lead to represent only two features (drawing approx 2 features orthogonally), when sparsity is not set (sparsity=0).</p>
<p>Here,</p>
<ul class="simple">
<li><p>a toy model is composed of a one layer Linear model with a ReLU filtering function.</p></li>
<li><p>compressing the toy model from a larger dim (49 dim) into a smaller dim (2 dim) via autoencoder model.</p></li>
<li><p>training the toy model on the MNIST hand-written digit image (28x28) datasets.</p></li>
<li><p>exploring if the datasets with the imagined 49 features will converge into 2 feature representations.</p></li>
</ul>
<br>
<p><img alt="alt text" src="../_images/exp1_diagram1.png" /></p>
<p><br><br></p>
<p>####################################################################################################
####################################################################################################
####################################################################################################</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="prepare-packages">
<h1>0-1. prepare packages<a class="headerlink" href="#prepare-packages" title="Link to this heading">#</a></h1>
<p>####################################################################################################
####################################################################################################
####################################################################################################</p>
<p><br><br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### import packages </span>

<span class="c1"># ml/nn</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>  <span class="c1"># all neural network modules</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>  <span class="c1"># Functions with no parameters -&gt; activation functions</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>  <span class="c1"># optimization algo</span>

<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span> <span class="c1"># easier dataset management, helps create mini batches</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">random_split</span> <span class="c1"># set train-test ratio</span>

<span class="c1"># import torchvision</span>
<span class="kn">import</span> <span class="nn">torchvision.datasets</span> <span class="k">as</span> <span class="nn">datasets</span>  <span class="c1"># standard datasets</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span> <span class="c1"># this for convert dataset to tensor</span>
<span class="kn">from</span> <span class="nn">torchvision.utils</span> <span class="kn">import</span> <span class="n">make_grid</span> <span class="c1"># this for visualization</span>

<span class="c1"># stats/ml #1</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># stats/ml #2</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">decomposition</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">manifold</span>
</pre></div>
</div>
</div>
</div>
<br>
<br><p><br><br></p>
<p>####################################################################################################
####################################################################################################
####################################################################################################</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="run-exp">
<h1>1-1. run exp<a class="headerlink" href="#run-exp" title="Link to this heading">#</a></h1>
<p>####################################################################################################
####################################################################################################
####################################################################################################</p>
<p><br><br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### set device</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cpu
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Define all parameters</span>

<span class="c1"># later these will be inserted at the beginning as args</span>

<span class="c1"># fixed</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">input_size</span> <span class="o">=</span> <span class="mi">784</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">hidden_size2</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># variable</span>
<span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">49</span>
<span class="n">lr1</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># lr for opt1 </span>
<span class="n">lr2</span> <span class="o">=</span> <span class="mf">0.0001</span> <span class="c1"># lr for opt2 # 0.001, or etc </span>
<span class="n">num_epochs1</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_epochs2</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### define original functions</span>

<span class="k">def</span> <span class="nf">calculate_angle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="c1"># Calculate the angle in radians using arctan2</span>
    <span class="n">radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># y is vertical component, x is horizontal component</span>
    <span class="c1"># Convert radians to degrees</span>
    <span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">radians</span><span class="p">)</span>
    <span class="c1"># Normalize the angle to the range [0, 360)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">degrees</span> <span class="o">%</span> <span class="mi">360</span>
    <span class="k">return</span> <span class="n">angle</span>

<span class="k">def</span> <span class="nf">norm_point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="c1"># Calculate the length of the vector</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Check where length is 0</span>
    <span class="n">zero_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Boolean mask for elements where length is 0</span>

    <span class="c1"># Initialize normalized coordinates</span>
    <span class="n">x_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="c1"># Perform normalization only where length != 0</span>
    <span class="n">x_norm</span><span class="p">[</span><span class="o">~</span><span class="n">zero_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">zero_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">length</span><span class="p">[</span><span class="o">~</span><span class="n">zero_mask</span><span class="p">]</span>
    <span class="n">y_norm</span><span class="p">[</span><span class="o">~</span><span class="n">zero_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">zero_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">length</span><span class="p">[</span><span class="o">~</span><span class="n">zero_mask</span><span class="p">]</span>
    
    <span class="c1"># For dimensions where length == 0, retain the original values</span>
    <span class="n">x_norm</span><span class="p">[</span><span class="n">zero_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">zero_mask</span><span class="p">]</span>
    <span class="n">y_norm</span><span class="p">[</span><span class="n">zero_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">zero_mask</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x_norm</span><span class="p">,</span> <span class="n">y_norm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### implement two single FC NN models</span>

<span class="k">class</span> <span class="nc">lin_model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>  
        <span class="nb">super</span><span class="p">(</span><span class="n">lin_model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span> <span class="c1"># input: 28x28=784, hidden: 7x7=49</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span> <span class="c1"># hidden: 49, num_classes: 10</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># 784-&gt;49</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># range within [-1:1]</span>
        <span class="n">x_h</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># add non-linearity</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x_h</span><span class="p">)</span> <span class="c1"># 49-&gt;10</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_h</span>

<span class="k">class</span> <span class="nc">ae_model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ae_model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span> <span class="c1"># input: 49, target_dim: 2, for visualising superposition in 2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">)</span> <span class="c1"># input: 2, target_dim: 49</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># 49-&gt;2</span>
        <span class="n">x_2d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># range within [-1:1]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x_2d</span><span class="p">)</span> <span class="c1"># 2-&gt;49</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># range within [-1:1]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># simulate lin_model&#39;s process</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_2d</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # define a SAE model</span>

<span class="c1"># # this will be added later</span>

<span class="c1"># class sae_model(nn.Module):</span>
    
<span class="c1">#     def __init__(self, in_dims, h_dims, sparsity_lambda=1e-4, sparsity_target=0.05):</span>
<span class="c1">#         super().__init__()</span>
<span class="c1">#         self.in_dims = in_dims</span>
<span class="c1">#         self.h_dims = h_dims</span>
<span class="c1">#         self.sparsity_lambda = sparsity_lambda # sparsity penalty impact</span>
<span class="c1">#         self.sparsity_target = sparsity_target # target sparsity distribution</span>
        
<span class="c1">#         self.encoder = nn.Sequential(</span>
<span class="c1">#             nn.Linear(self.in_dims, self.h_dims),</span>
<span class="c1">#             nn.Sigmoid() # range within [0:1]</span>
<span class="c1">#         )</span>
        
<span class="c1">#         self.decoder = nn.Sequential(</span>
<span class="c1">#             nn.Linear(self.h_dims, self.in_dims),</span>
<span class="c1">#             nn.Tanh() # range within [-1:1]</span>
<span class="c1">#         )</span>
    
<span class="c1">#     def forward(self, x):</span>
<span class="c1">#         encoded = self.encoder(x)</span>
<span class="c1">#         decoded = self.decoder(encoded)</span>
<span class="c1">#         return encoded, decoded</span>

<span class="c1">#     # kl divergence</span>
<span class="c1">#     def sparsity_penalty(self, encoded):</span>
<span class="c1">#         rho_hat = torch.mean(encoded, dim=0)</span>
<span class="c1">#         rho = self.sparsity_target</span>
<span class="c1">#         epsilon = 1e-8</span>
<span class="c1">#         rho_hat = torch.clamp(rho_hat, min=epsilon, max=1 - epsilon)</span>
<span class="c1">#         kl_divergence = rho * torch.log(rho / rho_hat) + (1 - rho) * torch.log((1 - rho) / (1 - rho_hat))</span>
<span class="c1">#         sparsity_penalty = torch.sum(kl_divergence)</span>
<span class="c1">#         return self.sparsity_lambda * sparsity_penalty</span>
    
<span class="c1">#     def loss_function(self, x_hat, x, encoded):</span>
<span class="c1">#         mse_loss = F.mse_loss(x_hat, x)</span>
<span class="c1">#         sparsity_loss = self.sparsity_penalty(encoded)</span>
<span class="c1">#         return mse_loss + sparsity_loss</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### define datasets</span>

<span class="c1"># load dataset</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;../dataset/&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;../dataset/&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### initialize model, loss, optimizer</span>

<span class="n">m1</span> <span class="o">=</span> <span class="n">lin_model</span><span class="p">(</span>
    <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> 
    <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> 
    <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span>
<span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">m2</span> <span class="o">=</span> <span class="n">ae_model</span><span class="p">(</span>
    <span class="n">input_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> 
    <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size2</span><span class="p">,</span> 
    <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span>
<span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Loss and Optimizer</span>
<span class="n">criterion1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">criterion2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>

<span class="n">opt1</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr1</span><span class="p">)</span> 
<span class="n">opt2</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### train and validaiton</span>

<span class="n">num_epochs1</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_epochs2</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1">###</span>
<span class="c1">### phase 1: prepare trained weights with larger dim</span>
<span class="c1">###</span>

<span class="c1"># training lin model</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs1</span><span class="p">):</span>

    <span class="c1"># Training</span>
    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>

        <span class="c1"># reshape [batch, 1, 28,28] to [batch, 28*28]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span>

        <span class="c1"># Step 1: Forward pass through model1</span>
        <span class="n">out1</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">m1</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># out1:[batch, 10] as 10 class, h1:[batch, 49] as 49 latent</span>
        
        <span class="c1"># Step 4: Compute loss1 and update model1</span>
        <span class="n">loss1</span> <span class="o">=</span> <span class="n">criterion1</span><span class="p">(</span><span class="n">out1</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="n">opt1</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss1</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">opt1</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="n">num_correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Validation</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_loader</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span>
            <span class="n">out1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">m1</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">out1</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">num_correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">num_samples</span> <span class="o">+=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">num_correct</span><span class="o">/</span><span class="n">num_samples</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch [</span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_epochs1</span><span class="si">}</span><span class="s2">], loss1: </span><span class="si">{</span><span class="n">loss1</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">###</span>
<span class="c1">### phase 2: train AE model weights with 2 dim</span>
<span class="c1">###</span>

<span class="c1"># training ae model and visualize results</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs2</span><span class="p">):</span>

    <span class="c1"># Training autoencoder model</span>
    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>

        <span class="c1"># reshape [batch, 1, 28,28] to [batch, 28*28]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">m1</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># out1:[batch, 10] as 10 class, h1:[batch, 49] as 49 latent</span>
            <span class="n">h1_clone</span> <span class="o">=</span> <span class="n">h1</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="n">out2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">m2</span><span class="p">(</span><span class="n">h1_clone</span><span class="p">)</span>  <span class="c1"># 49 -&gt; 2 -&gt; 49</span>

        <span class="n">loss2</span> <span class="o">=</span> <span class="n">criterion2</span><span class="p">(</span><span class="n">out2</span><span class="p">,</span> <span class="n">h1_clone</span><span class="p">)</span>
        <span class="n">opt2</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss2</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">opt2</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># visualization</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>

        <span class="c1"># Collecting data # lin model</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">m1</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">target_h1</span> <span class="o">=</span> <span class="n">h1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_h1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">target_h1</span><span class="p">,</span><span class="n">h1</span><span class="p">))</span>

        <span class="c1"># Collecting data # ae model</span>
        <span class="n">reconstruct_target_h1</span><span class="p">,</span> <span class="n">h2_2d</span> <span class="o">=</span> <span class="n">m2</span><span class="p">(</span><span class="n">target_h1</span><span class="p">)</span>
        
        <span class="c1"># Collecting data # original loss</span>
        <span class="n">target_loss2_orig</span> <span class="o">=</span> <span class="n">criterion2</span><span class="p">(</span><span class="n">reconstruct_target_h1</span><span class="p">,</span> <span class="n">target_h1</span><span class="p">)</span>

        <span class="c1"># Importance and xy2d coord calculation        </span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">large_model_dim</span> <span class="o">=</span> <span class="n">target_h1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_dim_2d</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">one_dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">large_model_dim</span><span class="p">):</span>

            <span class="c1"># importance</span>
            <span class="n">h1_perturb</span> <span class="o">=</span> <span class="n">target_h1</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">h1_perturb</span><span class="p">[:,</span><span class="n">one_dim</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">reconstruct_h1_perturb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">m2</span><span class="p">(</span><span class="n">h1_perturb</span><span class="p">)</span>
            <span class="n">loss2_perturb</span> <span class="o">=</span> <span class="n">criterion2</span><span class="p">(</span><span class="n">reconstruct_h1_perturb</span><span class="p">,</span> <span class="n">target_h1</span><span class="p">)</span>
            <span class="n">importance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss2_perturb</span> <span class="o">-</span> <span class="n">target_loss2_orig</span><span class="p">)</span>

            <span class="c1"># xy_2d</span>
            <span class="n">target_h1_one_dim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">target_h1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="c1"># batch, larger dim</span>
            <span class="n">target_h1_one_dim</span><span class="p">[:,</span><span class="n">one_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_h1</span><span class="p">[:,</span><span class="n">one_dim</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">target_h1_2d</span> <span class="o">=</span> <span class="n">m2</span><span class="p">(</span><span class="n">target_h1_one_dim</span><span class="p">)</span>
            <span class="n">target_dim_2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_h1_2d</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        
        <span class="n">target_dim_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_dim_2d</span><span class="p">)</span>
        
        <span class="c1"># calculate importance according to contribution to MSE loss</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">imp</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">importance</span><span class="p">)</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">importance</span><span class="p">])</span>
        <span class="c1"># importance[importance&lt;(1/large_model_dim)] = 0.0 # convert importance lower than expected contribution into 0</span>
        <span class="n">importance_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">importance</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">importance</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">importance</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">importance</span><span class="p">))</span> <span class="c1"># normalize value into 0-1 range</span>

        <span class="c1"># compute xy_coordinates</span>

        <span class="c1"># use raw xy2d with unrestricted magnitude vector as it is</span>
        <span class="n">xy_coord</span> <span class="o">=</span> <span class="n">importance_norm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">target_dim_2d</span> <span class="c1"># because calculate [large_dim,]*[large_dim,xy_coord]</span>
        <span class="c1"># xy_coord = xy_coord/np.abs(xy_coord).max() # adjust max magnitude to -1.0 to 1.0</span>
        <span class="n">x_coord</span> <span class="o">=</span> <span class="n">xy_coord</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_coord</span> <span class="o">=</span> <span class="n">xy_coord</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># set a magnitude of xy2d with 1</span>
        <span class="n">x_coord_norm</span><span class="p">,</span> <span class="n">y_coord_norm</span> <span class="o">=</span> <span class="n">norm_point</span><span class="p">(</span><span class="n">target_dim_2d</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_dim_2d</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x_coord_norm</span> <span class="o">=</span> <span class="n">x_coord_norm</span> <span class="o">*</span> <span class="n">importance_norm</span>
        <span class="n">y_coord_norm</span> <span class="o">=</span> <span class="n">y_coord_norm</span> <span class="o">*</span> <span class="n">importance_norm</span>

        <span class="c1"># graph visualization</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_coord</span><span class="p">)):</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_coord</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_coord</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">x_coord</span><span class="p">[</span><span class="n">i</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">y_coord</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_coord_norm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_coord_norm</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">x_coord_norm</span><span class="p">[</span><span class="n">i</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">y_coord_norm</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;imp * len=flex&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;imp * len=fix1&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch [</span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_epochs2</span><span class="si">}</span><span class="s2">], loss2: </span><span class="si">{</span><span class="n">loss2</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [1/10], loss1: 0.2355, accuracy: 0.9277
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [2/10], loss1: 0.0865, accuracy: 0.9419
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [3/10], loss1: 0.2696, accuracy: 0.9503
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [4/10], loss1: 0.1911, accuracy: 0.9530
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [5/10], loss1: 0.0844, accuracy: 0.9559
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [6/10], loss1: 0.1387, accuracy: 0.9588
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [7/10], loss1: 0.2276, accuracy: 0.9603
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [8/10], loss1: 0.0427, accuracy: 0.9600
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [9/10], loss1: 0.0200, accuracy: 0.9625
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [10/10], loss1: 0.1132, accuracy: 0.9633
</pre></div>
</div>
<img alt="../_images/0f277118a14d794c08842d079e1767068aaf15fab0c706d95cb0ac2f8a2c56ee.png" src="../_images/0f277118a14d794c08842d079e1767068aaf15fab0c706d95cb0ac2f8a2c56ee.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [1/20], loss2: 0.3069
</pre></div>
</div>
<img alt="../_images/5267d8a771e73d8aa35880198956f8da879fc4eaaa95b45e92dcb33cb9760320.png" src="../_images/5267d8a771e73d8aa35880198956f8da879fc4eaaa95b45e92dcb33cb9760320.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [2/20], loss2: 0.2868
</pre></div>
</div>
<img alt="../_images/fe4004cf04bdf91412d705656f6683cb6244a88ad266379472cbbf6a6abc9fe7.png" src="../_images/fe4004cf04bdf91412d705656f6683cb6244a88ad266379472cbbf6a6abc9fe7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [3/20], loss2: 0.2776
</pre></div>
</div>
<img alt="../_images/5457070053d0e8fd0c49de26379d9d2d02d2f78b7a4576fc4760fca50ecb9ded.png" src="../_images/5457070053d0e8fd0c49de26379d9d2d02d2f78b7a4576fc4760fca50ecb9ded.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [4/20], loss2: 0.2704
</pre></div>
</div>
<img alt="../_images/91ce8b2b6530f420ba8e9a1a262ed66c31598d0d30e07f6c6773026001a4f73a.png" src="../_images/91ce8b2b6530f420ba8e9a1a262ed66c31598d0d30e07f6c6773026001a4f73a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [5/20], loss2: 0.2756
</pre></div>
</div>
<img alt="../_images/e92f6708b530472dc2c5a8c0fe74486c1df2465531c4bd4e4ef1ac42be51ba77.png" src="../_images/e92f6708b530472dc2c5a8c0fe74486c1df2465531c4bd4e4ef1ac42be51ba77.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [6/20], loss2: 0.2516
</pre></div>
</div>
<img alt="../_images/6b639038a579007de9b3d216f0329885cfb6c3961b65a42da100f15747cbbb11.png" src="../_images/6b639038a579007de9b3d216f0329885cfb6c3961b65a42da100f15747cbbb11.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [7/20], loss2: 0.2363
</pre></div>
</div>
<img alt="../_images/5152349eaf05ace9bc293ca23d29c66d2f16d0d9df3df9cebbb4d2eb7a49fc29.png" src="../_images/5152349eaf05ace9bc293ca23d29c66d2f16d0d9df3df9cebbb4d2eb7a49fc29.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [8/20], loss2: 0.2084
</pre></div>
</div>
<img alt="../_images/931ae90a424dee96493e46a20ecea75632087367af37a2cfd435253bb18c9978.png" src="../_images/931ae90a424dee96493e46a20ecea75632087367af37a2cfd435253bb18c9978.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [9/20], loss2: 0.2132
</pre></div>
</div>
<img alt="../_images/22f1279031e47ed2bbb0dbc7ea3e65002bd3a758d43ebd7969d9b1072cac26cc.png" src="../_images/22f1279031e47ed2bbb0dbc7ea3e65002bd3a758d43ebd7969d9b1072cac26cc.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [10/20], loss2: 0.2086
</pre></div>
</div>
<img alt="../_images/c01d4f32ff5a472d1161c14082f76d640943d912ffb5ad099e2d8757ae70c975.png" src="../_images/c01d4f32ff5a472d1161c14082f76d640943d912ffb5ad099e2d8757ae70c975.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [11/20], loss2: 0.2023
</pre></div>
</div>
<img alt="../_images/44fd388fe7cd6186663ea4b4206267606595488cc4e928421b8d89a68a06140c.png" src="../_images/44fd388fe7cd6186663ea4b4206267606595488cc4e928421b8d89a68a06140c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [12/20], loss2: 0.2058
</pre></div>
</div>
<img alt="../_images/281c12982ef132f007e317819419aca877b7c1cabb457acad2cf1b36f01527f0.png" src="../_images/281c12982ef132f007e317819419aca877b7c1cabb457acad2cf1b36f01527f0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [13/20], loss2: 0.1913
</pre></div>
</div>
<img alt="../_images/8f00eee58b00a900750326676952b2c9b91b821438bf0819bd5556a7734e506b.png" src="../_images/8f00eee58b00a900750326676952b2c9b91b821438bf0819bd5556a7734e506b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [14/20], loss2: 0.1981
</pre></div>
</div>
<img alt="../_images/e2c8933aef9ea3487ce804354ac35989a19c9bc709a898ddc3e334c12123dfd9.png" src="../_images/e2c8933aef9ea3487ce804354ac35989a19c9bc709a898ddc3e334c12123dfd9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [15/20], loss2: 0.1886
</pre></div>
</div>
<img alt="../_images/ffdaccca32e1c582e5f4a12c934a549e38a9d7d566a64f8044a60ea5f027bfd9.png" src="../_images/ffdaccca32e1c582e5f4a12c934a549e38a9d7d566a64f8044a60ea5f027bfd9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [16/20], loss2: 0.1890
</pre></div>
</div>
<img alt="../_images/3786e3214b21ef56a94bd0b2c63e7281e53061ca5fa294189803d1a53bbd8999.png" src="../_images/3786e3214b21ef56a94bd0b2c63e7281e53061ca5fa294189803d1a53bbd8999.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [17/20], loss2: 0.1850
</pre></div>
</div>
<img alt="../_images/7aeaf0ddab8ccb4e52ad1ba529905613871622be72a8f4283d54be553b4ea353.png" src="../_images/7aeaf0ddab8ccb4e52ad1ba529905613871622be72a8f4283d54be553b4ea353.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [18/20], loss2: 0.1822
</pre></div>
</div>
<img alt="../_images/b28b43a068a6a617af2d3448764b33231a6253138be0e9490dd8ab7ccdcc8cc8.png" src="../_images/b28b43a068a6a617af2d3448764b33231a6253138be0e9490dd8ab7ccdcc8cc8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [19/20], loss2: 0.1823
</pre></div>
</div>
<img alt="../_images/b6ffd8f79a98a4e23ff3ab48fd56c686f29b01a0bf0c9271b16a860353538864.png" src="../_images/b6ffd8f79a98a4e23ff3ab48fd56c686f29b01a0bf0c9271b16a860353538864.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch [20/20], loss2: 0.1731
</pre></div>
</div>
</div>
</div>
<p><br><br></p>
<section id="result1">
<h2>Result1<a class="headerlink" href="#result1" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>m1 = the one layer linear model outputing a hidden layer dim (49 dim) while training the 10 class hand-wrriten digit images (28x28 = 784 dim).</p></li>
<li><p>m2 = the AE model training the larger hidden layer dim (49 dim) representing each feature in a smaller hidden layer dim (2 dim).</p></li>
<li><p>the left boxes are graphs representing each of 49 features computed by m2 output (2 dim, xy coordinates) multiplying with its importance.</p></li>
<li><p>the right boxes are graphs representing each of 49 features computed by a vector of m2 output (2 dim, xy coordinates) with fixed magnitude=1 multiplying with its importance.</p></li>
<li><p>49 features are aggregated into around 2 features over 20 epochs training.</p></li>
<li><p>In the middle of epochs training, representations become random but gradually converge into 2 dim.</p></li>
</ul>
<br>
<br>
</section>
<section id="exp2">
<h2>Exp2<a class="headerlink" href="#exp2" title="Link to this heading">#</a></h2>
<p>The second exp will test to replicate another <a class="reference external" href="https://transformer-circuits.pub/2022/toy_model/index.html">Anthropic research outcome (Elhage et al., 2022)</a> (see the first column of the <strong>ReLU Output Model</strong> in the diagram below). Namely, testing if the top important features (2 dim) are clearly represented in the toy model compared to the remaining least important features (47 dim), when sparsity is not set (sparsity=0).</p>
<p>Here,</p>
<ul class="simple">
<li><p>W in h = W * x is an AE transformation from x(49dim) to h(2dim).</p></li>
<li><p>b is a bias in h = W * x + b.</p></li>
<li><p>W<sup>T</sup> in x’ = ReLU(W<sup>T</sup> * W * x + b) is a reconstruction from h(2dim) to x’(49 dim)</p></li>
<li><p>W<sup>T</sup> * W represents cosine similarity matrix between features (48x48 matrix).</p></li>
<li><p>||<span class="math notranslate nohighlight">\(W_i\)</span>|| tests if each feature is clearly represented.</p></li>
<li><p><span class="math notranslate nohighlight">\(\sum_{j} (\hat{x}_i*x_j)^2\)</span> calculates similarity of a target feature, <span class="math notranslate nohighlight">\(\hat{x}_i\)</span>, with the remaining features.</p></li>
</ul>
<br>
<p><img alt="alt text" src="../_images/exp1_diagram2.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### demonstrate wT*w, W-norm, cos sim distance</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">fc1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">fc2</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">fc1</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">fc2</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    
    <span class="c1"># Sort the columns of &#39;a&#39; based on importance</span>
    <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">importance_norm</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Get indices that would sort the importance array</span>
    <span class="n">w1_sorted</span> <span class="o">=</span> <span class="n">w1</span><span class="p">[:,</span> <span class="n">sorted_indices</span><span class="p">]</span> <span class="c1"># Reorder the columns of &#39;a&#39; based on sorted indices</span>
    <span class="n">w2_sorted</span> <span class="o">=</span> <span class="n">w2</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># Reorder the columns of &#39;a&#39; based on sorted indices</span>
    <span class="n">b2_sorted</span> <span class="o">=</span> <span class="n">b2</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Reorder the columns of &#39;a&#39; based on sorted indices, and transpose as wT</span>

    <span class="n">w1_sorted_t</span> <span class="o">=</span> <span class="n">w1_sorted</span><span class="o">.</span><span class="n">T</span>
    <span class="n">mask_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w1_sorted_t</span><span class="p">)))</span>
    <span class="n">w1_cos_sim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">w2_cos_sim</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w1_sorted_t</span><span class="p">)):</span>
        <span class="n">w1_sorted_t_target</span> <span class="o">=</span> <span class="n">w1_sorted_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">idx_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_range</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">w1_sorted_t_ref</span> <span class="o">=</span> <span class="n">w1_sorted_t</span><span class="p">[</span><span class="o">~</span><span class="n">idx_mask</span><span class="p">]</span>
        <span class="n">cos_sim1</span> <span class="o">=</span> <span class="p">((</span><span class="n">w1_sorted_t_target</span> <span class="o">@</span> <span class="n">w1_sorted_t_ref</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">w1_cos_sim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cos_sim1</span><span class="p">)</span>

        <span class="n">w2_sorted_target</span> <span class="o">=</span> <span class="n">w2_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">idx_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_range</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">w2_sorted_ref</span> <span class="o">=</span> <span class="n">w2_sorted</span><span class="p">[</span><span class="o">~</span><span class="n">idx_mask</span><span class="p">]</span>
        <span class="n">cos_sim2</span> <span class="o">=</span> <span class="p">((</span><span class="n">w2_sorted_ref</span> <span class="o">@</span> <span class="n">w2_sorted_target</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">w2_cos_sim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cos_sim2</span><span class="p">)</span>

    <span class="n">w1_cos_dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w1_cos_sim</span><span class="p">)</span>
    <span class="n">w2_cos_dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w2_cos_sim</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">w1_sorted</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">w1_sorted</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">w_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">wtw</span> <span class="o">=</span> <span class="p">(</span><span class="n">w2_sorted</span> <span class="o">@</span> <span class="n">w1_sorted</span><span class="p">)</span>
    <span class="c1"># wtw = (w_sorted.T @ w_sorted)</span>

    <span class="n">wtw_clone</span> <span class="o">=</span> <span class="n">wtw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">thres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">wtw_clone</span><span class="p">,</span> <span class="p">[</span><span class="mi">99</span><span class="p">])</span>
    <span class="n">wtw_clone</span><span class="p">[</span><span class="n">wtw_clone</span><span class="o">&lt;</span><span class="n">thres</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">((</span><span class="mi">13</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w_norm</span><span class="p">)</span> <span class="c1"># ||Wi||</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b2_sorted</span><span class="p">)</span> <span class="c1"># b    </span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w1_cos_dis</span><span class="p">)</span> <span class="c1"># cos sim</span>
    <span class="n">pos1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wtw</span><span class="p">)</span>
    <span class="n">pos2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wtw_clone</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;||$W_</span><span class="si">{</span><span class="s1">&#39;i&#39;</span><span class="si">}</span><span class="s2">$||&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cos sim&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$W^TW$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$W^TW$, top1%&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1"># plt.savefig(&quot;img.png&quot;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d08a85b173efccb9ff0ba6ced011af8b3aa7e80c9b1e8d6fd411fc69a90e3aea.png" src="../_images/d08a85b173efccb9ff0ba6ced011af8b3aa7e80c9b1e8d6fd411fc69a90e3aea.png" />
</div>
</div>
<p><br><br></p>
</section>
<section id="result2">
<h2>Result2<a class="headerlink" href="#result2" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>x axis of all graphs here is importance ranks of features, 0th as the highest and 48th as the lowest.</p></li>
<li><p>higher ||Wi|| as its importance is higher.</p></li>
<li><p>larger b as importance is reduced.</p></li>
<li><p>cos sim: everything is around 0.</p></li>
<li><p><span class="math notranslate nohighlight">\(W^TW\)</span> shows a higher similarity as the feature importance is higher.</p></li>
</ul>
<br>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pos</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wtw_clone</span><span class="p">[:</span><span class="mi">5</span><span class="p">,:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$W^TW$, 5x5, top1%&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/864d835961c05cb48865dd6420df9e6dfc75b5daf8a34c97620fd8dcc12c4db1.png" src="../_images/864d835961c05cb48865dd6420df9e6dfc75b5daf8a34c97620fd8dcc12c4db1.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./nb"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="markdown.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Markdown Files</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">My Solo project #1</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exp1">Exp1</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-packages">0-1. prepare packages</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#run-exp">1-1. run exp</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#result1">Result1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exp2">Exp2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#result2">Result2</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>